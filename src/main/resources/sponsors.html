<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sponsors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/Sidebar.css}" href="static/css/Sidebar.css">
    <link rel="stylesheet" th:href="@{/css/Modal.css}" href="static/css/Modal.css">
    <link rel="stylesheet" th:href="@{/css/Table.css}" href="static/css/Table.css">
    <link rel="stylesheet" th:href="@{/css/sponsors.css}" href="static/css/sponsors.css">
    <script th:src="@{/js/contract.js}" src="static/js/contract.js" defer></script>
    <script th:src="@{/js/sponsors.js}" src="static/js/sponsors.js" defer></script>
    <script th:src="@{/js/service.js}" src="static/js/service.js" defer></script>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div class="flex min-h-screen">

      <!-- Sidebar -->
      <aside class="sidebar">
        <div>
          <div class="logo">VBK Sponsor System</div>

          <div class="menu">
          <button class="menu-btn" onclick="location.href='/homepage'">Forside</button>
          <button class="menu-btn" onclick="location.href='/archive'">Arkiv</button>
          <button class="menu-btn" onclick="location.href='/sponsors'">Sponsor Administration</button>
          <button class="menu-btn" onclick="location.href='/changelog'">Hændelses log</button>
          <button class="menu-btn" onclick="location.href='/AdminPanel'">Bruger Administration</button>
          </div>
        </div>

        <button class="logout-btn" onclick="location.href='/logout'">Log ud</button>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-6">
        <div th:if="${responseMessage}" class="mb-4 px-4 py-2 bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500 rounded">
          <p th:text="${responseMessage}"></p>
        </div>
        <div class="container bg-white rounded shadow p-6">
          <h1 class="text-2xl font-semibold mb-4">Sponsors</h1>

          <div class="grid md:grid-cols-2 gap-6">
            <section class="list">
                  <!-- Filtreringskontrol: viser hvilke sponsorer der skal vises -->
                  <div class="flex items-center mb-2">
                    <h2 class="text-lg font-medium mr-3 m-0">Viser:</h2>
                    <div class="text-sm">
                      <select id="sponsorFilter" class="border rounded px-2 py-1 text-sm" onchange="applySponsorFilter()" style="min-width:6rem">
                        <option value="all" selected>Alle Sponsorer</option>
                        <option value="active">Aktive Sponsorer</option>
                        <option value="inactive">Ikke-aktive Sponsorer</option>
                      </select>
                    </div>
                  </div>
              <!-- Liste over sponsorer (gentages via Thymeleaf th:each) -->
              <div th:if="${not #lists.isEmpty(sponsors)}">
                <div th:each="sponsor, stat : ${sponsors}" th:attr="data-active=${sponsor.active}" class="item sponsor-item relative mb-4 p-3 rounded bg-gray-50">
                  <div class="absolute right-3 top-3 flex space-x-2">
                    <button type="button" class="px-2 py-1 text-sm bg-blue-500 text-white rounded" th:attr="data-sponsor-id=${sponsor.id},data-sponsor-name=${sponsor.name}" onclick="openAddModal(this)">Tilføj Kontrakt</button>
                    <button type="button" class="px-2 py-1 text-sm bg-gray-200 rounded" th:attr="data-sponsor-id=${sponsor.id},data-sponsor-name=${sponsor.name}" onclick="openViewModal(this)">Se Kontrakterne</button>
                  </div>
                  <strong class="block text-lg" th:text="${sponsor.name}">Sponsor Navn</strong>
                  <div class="text-sm">Kontaktperson: <span th:text="${sponsor.contactPerson}">Kontaktperson</span></div>
                  <div class="text-sm">Email: <span th:text="${sponsor.email}">email</span></div>
                  <div class="text-sm">Telefon: <span th:text="${sponsor.phoneNumber}">Telefon</span></div>
                  <div class="text-sm">CVR: <span th:text="${sponsor.cvrNumber}">cvr</span></div>

                  <div class="text-sm">
                      Status: <span th:text="${sponsor.active} ? 'Aktiv' : 'Inaktiv'"></span>
                  </div>
                  <div class="text-sm">Kommentar: <span th:text="${sponsor.comments}">kommentar</span></div>
                  <!-- Kontroller for sponsor: edit og delete -->
                  <div class="mt-2">
                    <button type="button" class="px-3 py-1 bg-gray-200 rounded" th:onclick="|toggleSponsorEdit(${stat.index})|">Rediger</button>
                    <form th:action="@{/sponsors/delete}" method="POST" style="display:inline" th:onsubmit="return confirm('Delete sponsor and its contracts? This cannot be undone.')">
                      <input type="hidden" name="sponsorId" th:value="${sponsor.id}" />
                      <button type="submit" class="px-3 py-1 ml-2 bg-red-200 rounded">Slet</button>
                    </form>
                  </div>

                  <form th:id="|sponsorEditForm-${stat.index}|" th:action="@{/update/sponsor}" method="POST" style="display:none;margin-top:8px" class="form">
                    <input type="hidden" name="id" th:value="${sponsor.id}" />
                    <label class="block text-sm mt-2">Sponsor Navn</label>
                    <input name="name" th:value="${sponsor.name}" required class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">Kontaktperson</label>
                    <input name="contactPerson" th:value="${sponsor.contactPerson}" class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">Email</label>
                    <input name="email" type="email" th:value="${sponsor.email}" class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">Telefon</label>
                    <input name="phoneNumber" type="tel" inputmode="numeric" pattern="^[0-9]+$" title="Digits only" th:value="${sponsor.phoneNumber}" class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">CVR</label>
                    <input name="cvrNumber" th:value="${sponsor.cvrNumber}" class="border rounded px-2 py-1 w-full" />

                    <label class="block text-sm mt-2">Kommentar</label>
                    <input name="comments" th:value="${sponsor.comments}" class="border rounded px-2 py-1 w-full" />
                    <div class="mt-2">
                      <button type="submit" class="px-3 py-1 bg-green-200 rounded">Gem</button>
                      <button type="button" class="px-3 py-1 ml-2 bg-gray-200 rounded" th:onclick="|toggleSponsorEdit(${stat.index})|">Annuller</button>
                    </div>
                  </form>
                </div>
              </div>
              <!-- Hvis ingen sponsorer findes, vises en beseked -->
              <div th:if="${#lists.isEmpty(sponsors)}">Ingen sponsore endnu.</div>
            </section>

            <div>
              <section class="form mb-6">
                <h2 class="text-lg font-medium mb-2">Tilføj Sponsor</h2>
                <form action="/sponsors/add" method="POST" class="space-y-2">
                  <label class="block text-sm">Sponsor Navn</label>
                  <input id="name" name="name" required class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">Kontaktperson</label>
                  <input id="contactPerson" name="contactPerson" class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">Email</label>
                  <input id="email" name="email" type="email" class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">Telefon</label>
                  <input id="phoneNumber" name="phoneNumber" type="tel" inputmode="numeric" pattern="^[0-9]+$" title="Digits only" class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">CVR</label>
                  <input id="cvrNumber" name="cvrNumber" class="border rounded px-2 py-1 w-full" />

                  <label class="block text-sm">Kommentar</label>
                  <input id="comments" name="comments" class="border rounded px-2 py-1 w-full" />
                  <button type="submit" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">Tilføj Sponsor</button>
                </form>
              </section>
            </div>
          </div>

          <!--
            Skjult data-lager for kontrakter
            ----------------------------------
            Thymeleaf render alle kontrakter som usynlige divs med data- attributter.
            Dette bruges af klient-side JavaScript (populateViewContracts) til at bygge
            modal-indholdet dynamisk når brugeren ønsker at se en sponsors kontrakter.
          -->
          <div id="contractsData" style="display:none">
              <div th:each="contract : ${contracts}" class="contract-data"
                  th:attr="
                      data-id=${contract.id},
                      data-sponsor-id=${contract.sponsorId},
                      data-name=${contract.name},
                      data-type=${contract.type},
                      data-start=${contract.startDate},
                      data-end=${contract.endDate},
                      data-payment=${contract.payment},
                      data-active=${contract.active},
                      data-has-pdf=${contract.pdfData != null},
                      data-pdf-filename=${contract.fileName}"></div>
              </div>
            </div>
          <!-- Skjult data-lager for tjenester (services) -->
          <div id="servicesData" style="display:none">
              <div th:each="service : ${services}" class="service-data"
                th:attr="
                data-id=${service.id},
                data-contract-id=${service.contractId},
                data-name=${service.name},data-type=${service.type},
                data-start=${service.startDate},
                data-end=${service.endDate},
                data-amount=${service.amount},
                data-division=${service.division},
                data-active=${service.active}"
                >
            </div>
          </div>

          <!--
            Skjult skabelon for sponsor- <option> elementer
            ------------------------------------------------
            Indeholder option-elementer for alle sponsorer; JS kopierer denne HTML
            ind i dynamisk oprettede edit-formularer, så dropdown'en indeholder
            aktuelle sponsor-navne og id.
          -->
          <select id="sponsorOptionsTemplate" style="display:none">
            <option th:each="sponsor : ${sponsors}" th:value="${sponsor.id}" th:text="${sponsor.name}"></option>
          </select>

          <!--
            Genanvendelig modal: Tilføj kontrakt
            -------------------------------------
            Denne modal fyldes og vises af openAddModal(buttonEl). Formularen sender
            POST til /sponsors/addContract (controller håndterer oprettelse og redirect).
          -->
          <div id="addContractModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
            <div class="bg-white rounded p-4 w-11/12 max-w-md">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Tilføj Kontrakt for <span id="addModalSponsorName"></span></h3>
                <button type="button" class="text-gray-600" onclick="closeModal('addContractModal')">✕</button>
              </div>
              <form action="/sponsors/addContract" method="POST" class="space-y-2" enctype="multipart/form-data">
                <input id="addModalSponsorId" type="hidden" name="sponsorId" />
                <label class="block text-sm">Kontrakt Navn:</label>
                <input name="name" type="text" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Start Dato</label>
                <input name="startDate" type="date" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Slut Dato</label>
                <input name="endDate" type="date" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Beløb</label>
                <input name="payment" type="number" value="0" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Type</label>
                <input name="type" value="Standard" class="border rounded px-2 py-1 w-full" />

                <input type="file" accept=".pdf" id="fileyesyes" name = "pdffile">
                <div class="flex justify-end space-x-2 mt-2">
                  <button type="button" class="px-3 py-1 bg-gray-200 rounded" onclick="closeModal('addContractModal')">Annuller</button>
                  <button type="submit" class="px-3 py-1 bg-green-500 text-white rounded">Opret</button>
                </div>
              </form>
            </div>
          </div>
          <div id="viewContractsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
            <div class="bg-white rounded p-4 w-11/12 max-w-lg">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Kontrakter for <span id="viewModalSponsorName"></span></h3>
                <button type="button" class="text-gray-600" onclick="closeModal('viewContractsModal')">✕</button>
              </div>
              <div id="viewContractsList" class="space-y-2 overflow-auto max-h-96">
              </div>
            </div>
          </div>
          <!-- Add Service Modal -->
          <div id="addServiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
            <div class="bg-white rounded p-4 w-11/12 max-w-md">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Tilføj Tjeneste for <span id="addServiceContractName"></span></h3>
                <button type="button" class="text-gray-600" onclick="closeModal('addServiceModal')">✕</button>
              </div>
              <form action="/sponsors/addService" method="POST" class="space-y-2">
                <input id="addServiceContractId" type="hidden" name="contractId" />
                <label class="block text-sm">Navn</label>
                <input name="name" type="text" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Type</label>
                <select id="addServiceType" name="type" class="border rounded px-2 py-1 w-full">
                  <option value="Billetter">Billetter</option>
                  <option value="Kuponer">Kuponer</option>
                  <option value="Banner">Banner</option>
                  <option value="LogoTrojer">Logo på trøjer</option>
                  <option value="LogoBukser">Logo på bukser</option>
                </select>
                <div id="amountOrDivisionWrapper">
                  <label class="block text-sm">Antal</label>
                  <input name="amount" type="number" value="0" class="border rounded px-2 py-1 w-full" />
                </div>
                <label class="block text-sm">Start Dato</label>
                <input name="startDate" type="date" class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Slut Dato</label>
                <input name="endDate" type="date" class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Opfyldt</label>
                <select name="active" class="border rounded px-2 py-1 w-full">
                  <option value="false">Opfyldt</option>
                  <option value="true" selected>Ikke opfyldt</option>
                </select>
                <div class="flex justify-end space-x-2 mt-2">
                  <button type="button" class="px-3 py-1 bg-gray-200 rounded" onclick="closeModal('addServiceModal')">Annuller</button>
                  <button type="submit" class="px-3 py-1 bg-green-500 text-white rounded">Opret</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
