<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sponsors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/Sidebar.css}" href="static/css/Sidebar.css">
    <link rel="stylesheet" th:href="@{/css/Modal.css}" href="static/css/Modal.css">
    <link rel="stylesheet" th:href="@{/css/Table.css}" href="static/css/Table.css">
    <link rel="stylesheet" th:href="@{/css/sponsors.css}" href="static/css/sponsors.css">
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div class="flex min-h-screen">

      <!-- Sidebar -->
      <aside class="sidebar">
        <div>
          <div class="logo">VBK Sponsor System</div>

          <div class="menu">
            <button class="menu-btn" onclick="location.href='/homepage'">Forside</button>
            <button class="menu-btn" onclick="location.href='/sponsors'">Sponsors</button>
            <button class="menu-btn" onclick="location.href='/changelog'">Change log</button>
            <button class="menu-btn" onclick="location.href='/archive'">Arkiv</button>
            <button class="menu-btn" onclick="location.href='/AdminPanel'">Admin panel</button>
          </div>
        </div>

        <button class="logout-btn" onclick="location.href='/login'">Log ud</button>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-6">
        <div class="container bg-white rounded shadow p-6">
          <h1 class="text-2xl font-semibold mb-4">Sponsors</h1>

          <!-- Error besked area (Vis validation eller errors) -->
          <div
            th:if="${error}"
            class="mb-4 rounded p-3"
            style="background:#ffe6e6;border:1px solid #ff8080;color:#600"
          >
            <strong class="text-red-700">Error:</strong>
            <span th:text="${error}" class="ml-2"></span>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <section class="list">
                  <div class="flex items-center mb-2">
                    <h2 class="text-lg font-medium mr-3 m-0">Viser:</h2>
                    <div class="text-sm">
                      <select id="sponsorFilter" class="border rounded px-2 py-1 text-sm" onchange="applySponsorFilter()" style="min-width:6rem">
                        <option value="active" selected>Aktive Sponsor</option>
                        <option value="inactive">Ikke-aktive Sponsor</option>
                        <option value="all">Alle Sponsor</option>
                      </select>
                    </div>
                  </div>
              <div th:if="${not #lists.isEmpty(sponsors)}">
                <div th:each="sponsor, stat : ${sponsors}" th:attr="data-status=${sponsor.status}" class="item sponsor-item relative mb-4 p-3 rounded bg-gray-50">
                  <div class="absolute right-3 top-3 flex space-x-2">
                    <button type="button" class="px-2 py-1 text-sm bg-blue-500 text-white rounded" th:attr="data-sponsor-id=${sponsor.id},data-sponsor-name=${sponsor.name}" onclick="openAddModal(this)">Tilføj Kontrakt</button>
                    <button type="button" class="px-2 py-1 text-sm bg-gray-200 rounded" th:attr="data-sponsor-id=${sponsor.id},data-sponsor-name=${sponsor.name}" onclick="openViewModal(this)">Se Kontrakterne</button>
                  </div>
                  <strong class="block text-lg" th:text="${sponsor.name}">Sponsor Navn</strong>
                  <div class="text-sm">Kontaktperson: <span th:text="${sponsor.contactPerson}">Kontaktperson</span></div>
                  <div class="text-sm">Email: <span th:text="${sponsor.email}">email</span></div>
                  <div class="text-sm">Telefon: <span th:text="${sponsor.phoneNumber}">Telefon</span></div>
                  <div class="text-sm">CVR: <span th:text="${sponsor.cvrNumber}">cvr</span></div>
                  <div class="text-sm">Status: <span th:text="${sponsor.status}">status</span></div>
                  <div class="text-sm">Kommentar: <span th:text="${sponsor.comments}">kommentar</span></div>
                  <div class="mt-2">
                    <button type="button" class="px-3 py-1 bg-gray-200 rounded" th:onclick="|toggleSponsorEdit(${stat.index})|">Edit</button>
                    <form th:action="@{/sponsors/delete}" method="POST" style="display:inline" th:onsubmit="return confirm('Delete sponsor and its contracts? This cannot be undone.')">
                      <input type="hidden" name="sponsorId" th:value="${sponsor.id}" />
                      <button type="submit" class="px-3 py-1 ml-2 bg-red-200 rounded">Delete</button>
                    </form>
                  </div>

                  <form th:id="|sponsorEditForm-${stat.index}|" th:action="@{/update/sponsor}" method="POST" style="display:none;margin-top:8px" class="form">
                    <input type="hidden" name="id" th:value="${sponsor.id}" />
                    <label class="block text-sm mt-2">Sponsor Navn</label>
                    <input name="name" th:value="${sponsor.name}" required class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">Kontaktperson</label>
                    <input name="contactPerson" th:value="${sponsor.contactPerson}" class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">Email</label>
                    <input name="email" type="email" th:value="${sponsor.email}" class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">Telefon</label>
                    <input name="phoneNumber" type="tel" inputmode="numeric" pattern="^[0-9]+$" title="Digits only" th:value="${sponsor.phoneNumber}" class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">CVR</label>
                    <input name="cvrNumber" th:value="${sponsor.cvrNumber}" class="border rounded px-2 py-1 w-full" />
                    <label class="block text-sm mt-2">Aktiv</label>
                    <select name="status" class="border rounded px-2 py-1 w-full">
                      <option value="true" th:selected="${sponsor.status}">True</option>
                      <option value="false" th:selected="${!sponsor.status}">False</option>
                    </select>
                    <label class="block text-sm mt-2">Kommentar</label>
                    <input name="comments" th:value="${sponsor.comments}" class="border rounded px-2 py-1 w-full" />
                    <div class="mt-2">
                      <button type="submit" class="px-3 py-1 bg-green-200 rounded">Gem</button>
                      <button type="button" class="px-3 py-1 ml-2 bg-gray-200 rounded" th:onclick="|toggleSponsorEdit(${stat.index})|">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
              <div th:if="${#lists.isEmpty(sponsors)}">Ingen Sponsors Inu.</div>
            </section>

            <div>
              <section class="form mb-6">
                <h2 class="text-lg font-medium mb-2">Tilføj Sponsor</h2>
                <form action="/sponsors/add" method="POST" class="space-y-2">
                  <label class="block text-sm">Sponsor Navn</label>
                  <input id="name" name="name" required class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">Kontaktperson</label>
                  <input id="contactPerson" name="contactPerson" class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">Email</label>
                  <input id="email" name="email" type="email" class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">Telefon</label>
                  <input id="phoneNumber" name="phoneNumber" type="tel" inputmode="numeric" pattern="^[0-9]+$" title="Digits only" class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">CVR</label>
                  <input id="cvrNumber" name="cvrNumber" class="border rounded px-2 py-1 w-full" />
                  <label class="block text-sm">Aktive</label>
                  <select id="status" name="status" class="border rounded px-2 py-1 w-full">
                    <option value="true">True</option>
                    <option value="false" selected>False</option>
                  </select>
                  <label class="block text-sm">Kommentar</label>
                  <input id="comments" name="comments" class="border rounded px-2 py-1 w-full" />
                  <button type="submit" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">Add Sponsor</button>
                </form>
              </section>
            </div>
          </div>

          <!-- Hidden contracts dataset for client-side rendering (used by view modal) -->
          <div id="contractsData" style="display:none">
            <div th:each="c : ${contracts}" class="contract-data"
                 th:attr="data-id=${c.id},data-sponsor-id=${c.sponsorId},data-name=${c.name},data-type=${c.type},data-start=${c.startDate},data-end=${c.endDate},data-payment=${c.payment},data-status=${c.status}">
            </div>
          </div>

          <!-- Hidden sponsor options template for edit forms -->
          <select id="sponsorOptionsTemplate" style="display:none">
            <option th:each="s : ${sponsors}" th:value="${s.id}" th:text="${s.name}"></option>
          </select>

          <!-- Reusable Add Contract Modal -->
          <div id="addContractModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
            <div class="bg-white rounded p-3 w-11/12 max-w-sm">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Tilføj Kontrakt for <span id="addModalSponsorName"></span></h3>
                <button type="button" class="text-gray-600" onclick="closeModal('addContractModal')">✕</button>
              </div>
              <form action="/sponsors/addContract" method="POST" class="space-y-2">
                <input id="addModalSponsorId" type="hidden" name="sponsorId" />
                <label class="block text-sm">Contract name:</label>
                <input name="name" type="text" required class="border rounded px-2 py-1 w-full text-sm" />
                <label class="block text-sm">Start Date</label>
                <input name="startDate" type="date" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">End Date</label>
                <input name="endDate" type="date" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Payment (integer)</label>
                <input name="payment" type="number" value="0" required class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Type</label>
                <input name="type" value="Standard" class="border rounded px-2 py-1 w-full" />
                <label class="block text-sm">Active</label>
                <select name="status" class="border rounded px-2 py-1 w-full">
                  <option value="true">True</option>
                  <option value="false" selected>False</option>
                </select>
                <div class="flex justify-end space-x-2 mt-2">
                  <button type="button" class="px-2 py-1 text-sm bg-gray-200 rounded" onclick="closeModal('addContractModal')">Annuller</button>
                  <button type="submit" class="px-2 py-1 text-sm bg-green-500 text-white rounded">Opret</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Reusable View Contracts Modal -->
          <div id="viewContractsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
            <div class="bg-white rounded p-3 w-11/12 max-w-md">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Kontrakter for <span id="viewModalSponsorName"></span></h3>
                <button type="button" class="text-gray-600" onclick="closeModal('viewContractsModal')">✕</button>
              </div>
              <div id="viewContractsList" class="space-y-2 overflow-auto max-h-64 text-sm">
                <!-- Filled by JS -->
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      function toggleSponsorEdit(i) {
        const id = "sponsorEditForm-" + i;
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = el.style.display === "none" || el.style.display === "" ? "block" : "none";
      }
      function toggleContractEdit(i) {
        const id = "contractEditForm-" + i;
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = el.style.display === "none" || el.style.display === "" ? "block" : "none";
      }
      (function () {
        function attachPhoneHandlers(el) {
          if (!el) return;
          el.addEventListener("keydown", function (e) {
            const k = e.key;
            if (k.length !== 1) return;
            if (!/^[0-9]$/.test(k)) {
              e.preventDefault();
            }
          });
          el.addEventListener("paste", function (e) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData("text") || "";
            const filtered = text.replace(/[^0-9]/g, "");
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const before = el.value.slice(0, start);
            const after = el.value.slice(end);
            el.value = before + filtered + after;
            const caret = start + filtered.length;
            el.setSelectionRange(caret, caret);
          });
          el.addEventListener("input", function () {
            const cleaned = el.value.replace(/[^0-9]/g, "");
            if (cleaned !== el.value) {
              const pos = Math.max(0, el.selectionStart - (el.value.length - cleaned.length));
              el.value = cleaned;
              el.setSelectionRange(pos, pos);
            }
          });
        }
        attachPhoneHandlers(document.getElementById("phoneNumber"));
        document.querySelectorAll('input[name="phoneNumber"]').forEach(attachPhoneHandlers);

        // Sponsor filtering: show/hide sponsor items based on the select
        function applySponsorFilter() {
          const sel = document.getElementById('sponsorFilter');
          if (!sel) return;
          const v = sel.value;
          document.querySelectorAll('.sponsor-item').forEach(function (el) {
            const status = el.getAttribute('data-status');
            if (v === 'all') {
              el.style.display = '';
            } else if (v === 'active') {
              el.style.display = status === 'true' || status === 'True' ? '' : 'none';
            } else if (v === 'inactive') {
              el.style.display = status === 'false' || status === 'False' ? '' : 'none';
            }
          });
        }

        // xxxxx
        const filterEl = document.getElementById('sponsorFilter');
        if (filterEl) {
          filterEl.value = 'active';
          applySponsorFilter();
          filterEl.addEventListener('change', applySponsorFilter);
        }
      })();

      // Modal helpers (exposed globally so inline onclick handlers can call them)
      function openAddModal(buttonEl) {
        try {
          const sid = buttonEl.getAttribute('data-sponsor-id');
          const sname = buttonEl.getAttribute('data-sponsor-name') || '';
          document.getElementById('addModalSponsorId').value = sid;
          document.getElementById('addModalSponsorName').textContent = sname;
          document.getElementById('addContractModal').style.display = 'flex';
        } catch (e) {
          console.error('openAddModal error', e);
        }
      }

      function openViewModal(buttonEl) {
        try {
          const sid = buttonEl.getAttribute('data-sponsor-id');
          const sname = buttonEl.getAttribute('data-sponsor-name') || '';
          document.getElementById('viewModalSponsorName').textContent = sname || ('#' + sid);
          populateViewContracts(sid);
          document.getElementById('viewContractsModal').style.display = 'flex';
        } catch (e) {
          console.error('openViewModal error', e);
        }
      }

      function closeModal(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = 'none';
      }

      // Build the contract list for a sponsor by reading the hidden contracts dataset
      function populateViewContracts(sponsorId) {
        const listEl = document.getElementById('viewContractsList');
        if (!listEl) return;
        listEl.innerHTML = '';
        const container = document.getElementById('contractsData');
        if (!container) return;
        const nodes = container.querySelectorAll('.contract-data');
        const matches = [];
        nodes.forEach(function (n) {
          if (String(n.getAttribute('data-sponsor-id')) === String(sponsorId)) {
            matches.push(n);
          }
        });
        if (matches.length === 0) {
          listEl.innerHTML = '<div class="text-sm text-gray-600">Ingen kontrakter for denne sponsor.</div>';
          return;
        }
        const sponsorDisplayName = (document.getElementById('viewModalSponsorName') || {}).textContent || '';
        matches.forEach(function (n, idx) {
          const id = n.getAttribute('data-id');
          const name = n.getAttribute('data-name') || '';
          const type = n.getAttribute('data-type') || '';
          const start = n.getAttribute('data-start') || '';
          const end = n.getAttribute('data-end') || '';
          const payment = n.getAttribute('data-payment') || '';
          const status = n.getAttribute('data-status') || '';

          const item = document.createElement('div');
          item.className = 'border rounded p-2';

          // Build DOM nodes 
          const header = document.createElement('div');
          header.className = 'flex justify-between items-center';

          const title = document.createElement('div');
          title.className = 'font-medium';
          title.appendChild(document.createTextNode(name + ' '));
          const idSpan = document.createElement('span');
          idSpan.className = 'text-xs text-gray-500';
          idSpan.appendChild(document.createTextNode('( #' + id + ' )'));
          title.appendChild(idSpan);

          const actions = document.createElement('div');
          actions.className = 'flex space-x-2';

          const visBtn = document.createElement('button');
          visBtn.type = 'button';
          visBtn.className = 'px-2 py-1 text-sm bg-gray-100 rounded';
          visBtn.appendChild(document.createTextNode('Vis/Skjul'));
          visBtn.addEventListener('click', function () {
            const d = document.getElementById('details-' + idx);
            if (!d) return;
            d.style.display = d.style.display === 'none' ? 'block' : 'none';
          });

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'px-2 py-1 text-sm bg-yellow-200 rounded';
          editBtn.appendChild(document.createTextNode('Edit'));
          editBtn.addEventListener('click', function () {
            const e = document.getElementById('editform-' + idx);
            if (!e) return;
            e.style.display = e.style.display === 'none' ? 'block' : 'none';
          });

          actions.appendChild(visBtn);
          actions.appendChild(editBtn);
          header.appendChild(title);
          header.appendChild(actions);

          const detailsDiv = document.createElement('div');
          detailsDiv.id = 'details-' + idx;
          detailsDiv.style.display = 'none';
          detailsDiv.className = 'mt-2 text-sm text-gray-700';
          ['Type: ' + type, 'Start: ' + start, 'End: ' + end, 'Payment: ' + payment, 'Status: ' + status].forEach(function (txt) {
            const d = document.createElement('div');
            d.appendChild(document.createTextNode(txt));
            detailsDiv.appendChild(d);
          });

          const editDiv = document.createElement('div');
          editDiv.id = 'editform-' + idx;
          editDiv.style.display = 'none';
          editDiv.className = 'mt-2 text-sm text-gray-700 border-t pt-2';

          const form = document.createElement('form');
          form.action = '/update/contract';
          form.method = 'POST';
          form.className = 'space-y-2';

          const hid = document.createElement('input'); hid.type = 'hidden'; hid.name = 'id'; hid.value = id; form.appendChild(hid);
          const hsn = document.createElement('input'); hsn.type = 'hidden'; hsn.name = 'sponsorName'; hsn.value = sponsorDisplayName; form.appendChild(hsn);

          const lblSponsor = document.createElement('label'); lblSponsor.className = 'block text-sm'; lblSponsor.appendChild(document.createTextNode('Sponsor')); form.appendChild(lblSponsor);
          const selSponsor = document.createElement('select'); selSponsor.id = 'sponsor-select-' + idx; selSponsor.name = 'sponsorId'; selSponsor.className = 'border rounded px-2 py-1 w-full'; form.appendChild(selSponsor);

          const lblName = document.createElement('label'); lblName.className = 'block text-sm'; lblName.appendChild(document.createTextNode('Name')); form.appendChild(lblName);
          const inName = document.createElement('input'); inName.name = 'name'; inName.type = 'text'; inName.value = name; inName.className = 'border rounded px-2 py-1 w-full'; form.appendChild(inName);

          const lblType = document.createElement('label'); lblType.className = 'block text-sm'; lblType.appendChild(document.createTextNode('Type')); form.appendChild(lblType);
          const inType = document.createElement('input'); inType.name = 'type'; inType.type = 'text'; inType.value = type; inType.className = 'border rounded px-2 py-1 w-full'; form.appendChild(inType);

          const lblStart = document.createElement('label'); lblStart.className = 'block text-sm'; lblStart.appendChild(document.createTextNode('Start Date')); form.appendChild(lblStart);
          const inStart = document.createElement('input'); inStart.name = 'startDate'; inStart.type = 'date'; inStart.value = start; inStart.className = 'border rounded px-2 py-1 w-full'; form.appendChild(inStart);

          const lblEnd = document.createElement('label'); lblEnd.className = 'block text-sm'; lblEnd.appendChild(document.createTextNode('End Date')); form.appendChild(lblEnd);
          const inEnd = document.createElement('input'); inEnd.name = 'endDate'; inEnd.type = 'date'; inEnd.value = end; inEnd.className = 'border rounded px-2 py-1 w-full'; form.appendChild(inEnd);

          const lblPayment = document.createElement('label'); lblPayment.className = 'block text-sm'; lblPayment.appendChild(document.createTextNode('Payment')); form.appendChild(lblPayment);
          const inPayment = document.createElement('input'); inPayment.name = 'payment'; inPayment.type = 'number'; inPayment.value = payment; inPayment.className = 'border rounded px-2 py-1 w-full'; form.appendChild(inPayment);

          const lblStatus = document.createElement('label'); lblStatus.className = 'block text-sm'; lblStatus.appendChild(document.createTextNode('Active')); form.appendChild(lblStatus);
          const selStatus = document.createElement('select'); selStatus.id = 'status-select-' + idx; selStatus.name = 'status'; selStatus.className = 'border rounded px-2 py-1 w-full';
          const optTrue = document.createElement('option'); optTrue.value = 'true'; optTrue.appendChild(document.createTextNode('True'));
          const optFalse = document.createElement('option'); optFalse.value = 'false'; optFalse.appendChild(document.createTextNode('False'));
          selStatus.appendChild(optTrue); selStatus.appendChild(optFalse); form.appendChild(selStatus);

          const btnWrap = document.createElement('div'); btnWrap.className = 'flex justify-end space-x-2 mt-2';
          const btnCancel = document.createElement('button'); btnCancel.type = 'button'; btnCancel.className = 'px-3 py-1 bg-gray-200 rounded'; btnCancel.appendChild(document.createTextNode('Cancel'));
          btnCancel.addEventListener('click', function () { document.getElementById('editform-' + idx).style.display = 'none'; });
          const btnSave = document.createElement('button'); btnSave.type = 'submit'; btnSave.className = 'px-3 py-1 bg-green-500 text-white rounded'; btnSave.appendChild(document.createTextNode('Save'));
          btnWrap.appendChild(btnCancel); btnWrap.appendChild(btnSave);
          form.appendChild(btnWrap);

          editDiv.appendChild(form);

          item.appendChild(header);
          item.appendChild(detailsDiv);
          item.appendChild(editDiv);
          listEl.appendChild(item);
          // populate sponsor select and status value after append
          try {
            const template = document.getElementById('sponsorOptionsTemplate');
            if (template) {
              const sel = document.getElementById('sponsor-select-'+idx);
              if (sel) sel.innerHTML = template.innerHTML;
              if (sel) sel.value = n.getAttribute('data-sponsor-id');
            }
            const statusSel = document.getElementById('status-select-'+idx);
            if (statusSel) statusSel.value = String(status) === 'true' || String(status) === 'True' ? 'true' : 'false';
          } catch (err) {
            console.error('populateViewContracts: cannot populate selects', err);
          }
        });
      }

      // basic escaping to avoid injection when rendering attributes
      function escapeHtml(s) {
        if (!s && s !== 0) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }
    </script>
  </body>
</html>
